# タスク定義

## フェーズ1: プロジェクト基盤構築

- [x] プロジェクト初期化
  - 目的: 開発に必要なプロジェクト構造と設定ファイルを整備する
  - 詳細: package.json作成、TypeScript/Vite/Vitest/Tailwind CSSの設定、ディレクトリ構造の作成
  - 完了条件: `npm install`が成功し、`npm run dev`で開発サーバーが起動する

- [x] 型定義の作成
  - 目的: アプリケーション全体で使用する型を定義する
  - 詳細: Session, Participant, LotteryState, WebSocketメッセージ型をsrc/types/index.tsに定義
  - 完了条件: 型定義ファイルが作成され、コンパイルエラーがない

- [x] 共通レイアウトの作成
  - 目的: 全画面で共通して使用するHTMLレイアウトを作成する
  - 詳細: Hono JSXでlayout.tsxを作成、Tailwind CSS/htmxの読み込みを含める
  - 完了条件: レイアウトコンポーネントが作成され、基本的なHTML構造が出力される

## フェーズ2: コアサービス実装

- [x] インメモリストアの実装
  - 目的: セッションデータを一時的に保持する仕組みを構築する
  - 詳細: src/store/memory-store.tsにMapベースのストアを実装、24時間TTLによる自動削除機能を含める
  - 完了条件: セッションのCRUD操作が可能で、TTL経過後にデータが削除される

- [x] SessionManagerの実装
  - 目的: セッションのライフサイクル管理機能を提供する
  - 詳細: セッション作成（ID・パスコード生成）、参加者追加（番号割当）、セッション取得機能を実装
  - 完了条件: ユニットテストが通過し、セッション作成・参加・取得が正常に動作する

- [x] LotteryEngineの実装
  - 目的: 公平な抽選ロジックを提供する
  - 詳細: 未当選者からのランダム抽選、リセット機能、完了判定機能を実装
  - 完了条件: ユニットテストが通過し、全員が1回ずつ当選するまで抽選が正常に動作する

## フェーズ3: HTTPルート実装

- [ ] トップページ（セッション作成画面）の実装
  - 目的: 司会者がセッションを作成できる画面を提供する
  - 詳細: GET `/`でフォーム表示、POST `/sessions`でセッション作成、作成後に司会者画面へリダイレクト
  - 完了条件: 参加者数を入力してセッションを作成でき、URLとパスコードが表示される

- [ ] 参加者画面の実装
  - 目的: 参加者が抽選番号を確認し、当選結果を受け取れる画面を提供する
  - 詳細: GET `/session/:id`で画面表示、POST `/session/:id/join`で参加処理、名前入力フォームを含める
  - 完了条件: URLアクセスで参加でき、抽選番号が画面に表示される

- [ ] 司会者画面の実装
  - 目的: 司会者が抽選を進行できる画面を提供する
  - 詳細: GET `/session/:id/host`で画面表示、POST `/session/:id/host/auth`で認証、参加者一覧・抽選ボタンを含める
  - 完了条件: パスコード認証後に司会者画面にアクセスでき、参加者一覧が表示される

## フェーズ4: リアルタイム通信実装

- [ ] WebSocketハンドラの実装
  - 目的: サーバーとクライアント間のリアルタイム通信を実現する
  - 詳細: 接続管理、メッセージルーティング、セッション単位でのブロードキャスト機能を実装
  - 完了条件: WebSocket接続が確立でき、メッセージの送受信が正常に動作する

- [ ] 抽選実行・結果配信の実装
  - 目的: 司会者の抽選操作を参加者にリアルタイムで通知する
  - 詳細: lottery:drawイベント処理、当選者への個別通知、全体への結果ブロードキャストを実装
  - 完了条件: 抽選ボタン押下で当選者が決定し、参加者画面に1秒以内で結果が反映される

- [ ] 再接続機能の実装
  - 目的: 接続断から復帰できる仕組みを提供する
  - 詳細: クライアント側の自動再接続ロジック、接続状態表示、再接続後の状態同期を実装
  - 完了条件: 接続断から30秒以内に自動再接続し、最新の状態が表示される

## フェーズ5: UI/UX改善

- [ ] レスポンシブデザインの適用
  - 目的: スマートフォンでも快適に利用できるUIを実現する
  - 詳細: Tailwind CSSのレスポンシブユーティリティを使用、モバイルファーストで各画面を調整
  - 完了条件: スマートフォン・タブレット・PCで適切にレイアウトが調整される

- [ ] 当選演出の実装
  - 目的: 当選時の視覚的なフィードバックを提供する
  - 詳細: 当選者画面でのハイライト表示、アニメーション効果を実装
  - 完了条件: 当選時に視覚的に分かりやすい演出が表示される

- [ ] 接続状態インジケータの実装
  - 目的: ユーザーに接続状態を明示する
  - 詳細: 接続中/切断中の状態表示、再接続中のローディング表示を実装
  - 完了条件: 接続状態が画面上に常に表示され、状態変化が反映される

## フェーズ6: テスト・品質保証

- [ ] ユニットテストの整備
  - 目的: 主要機能の品質を担保する
  - 詳細: SessionManager、LotteryEngineのテストを作成、エッジケースをカバー
  - 完了条件: テストカバレッジが主要機能で80%以上

- [ ] 統合テストの作成
  - 目的: 画面遷移とAPI連携の動作を検証する
  - 詳細: セッション作成→参加→抽選の一連のフローをテスト
  - 完了条件: E2Eシナリオが正常に通過する

- [ ] 負荷テストの実施
  - 目的: 50名同時接続での動作を検証する
  - 詳細: WebSocket50接続での抽選実行、レスポンスタイム計測
  - 完了条件: 50名同時接続で抽選結果が1秒以内に反映される

## フェーズ間依存関係

```
フェーズ1: プロジェクト基盤構築
    │
    ▼
フェーズ2: コアサービス実装
    │
    ├──────────────┐
    ▼              ▼
フェーズ3        フェーズ4
HTTPルート      リアルタイム通信
    │              │
    └──────┬───────┘
           ▼
    フェーズ5: UI/UX改善
           │
           ▼
    フェーズ6: テスト・品質保証
```

## 要件トレーサビリティ

| タスク | 関連要件ID |
|--------|------------|
| プロジェクト初期化 | NFR-401 |
| 型定義の作成 | NFR-401 |
| インメモリストア | C-101 |
| SessionManager | FR-001, FR-002, FR-003, FR-101, FR-102 |
| LotteryEngine | FR-202, FR-205, FR-206 |
| トップページ | FR-001, FR-002, FR-003 |
| 参加者画面 | FR-101, FR-102, FR-103, FR-104, FR-105 |
| 司会者画面 | FR-201, FR-202, FR-203, FR-204, NFR-302 |
| WebSocketハンドラ | FR-301, C-002 |
| 抽選実行・結果配信 | FR-202, FR-204, FR-301, NFR-002 |
| 再接続機能 | FR-303, NFR-102 |
| レスポンシブデザイン | NFR-201 |
| ユニットテスト | NFR-402 |
| 負荷テスト | NFR-003 |
