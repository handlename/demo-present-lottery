# プレゼント交換サポートWebアプリ

プレゼント交換イベントの抽選をサポートするWebアプリケーションです。参加者にリアルタイムで抽選番号を配布し、司会者が抽選を実行すると当選結果が即座に参加者の画面に表示されます。

## 機能

- セッション作成（5〜50名まで対応）
- 参加者への抽選番号自動割当
- リアルタイム抽選結果配信（WebSocket）
- 当選時の視覚的演出（紙吹雪アニメーション）
- 自動再接続機能
- レスポンシブデザイン（スマートフォン対応）

## 必要環境

- Node.js 20 LTS 以上
- npm

## セットアップ

```bash
# 依存関係のインストール
npm install
```

## 起動方法

### 開発サーバー

```bash
npm run dev
```

サーバーが起動したら http://localhost:3000 にアクセスしてください。

### 本番ビルド

```bash
# ビルド
npm run build

# 本番サーバー起動
npm start
```

## 使用方法

### 1. セッション作成（主催者）

1. トップページ（http://localhost:3000）にアクセス
2. 参加者数（5〜50名）を入力して「セッションを作成」をクリック
3. 表示された「参加者用URL」と「司会者パスコード」を控える

### 2. 参加者の参加

1. 参加者用URLを参加者に共有（QRコード等）
2. 参加者がURLにアクセスし、名前（任意）を入力して「参加する」をクリック
3. 抽選番号が画面に表示される

### 3. 抽選の実行（司会者）

1. 司会者画面（`/session/{セッションID}/host`）にアクセス
2. パスコードを入力して認証
3. 参加者が揃ったら「抽選する」ボタンをクリック
4. 当選者の番号が表示され、参加者の画面にもリアルタイムで通知される
5. 全員が当選するまで繰り返す

### 4. 抽選のリセット

司会者画面の「リセット」ボタンで抽選をやり直すことができます。

## 画面構成

| 画面 | パス | 説明 |
|------|------|------|
| トップページ | `/` | セッション作成 |
| 参加者画面 | `/session/:id` | 抽選番号表示、当選結果受信 |
| 司会者画面 | `/session/:id/host` | 抽選実行、参加者管理 |

## 技術スタック

- **ランタイム**: Node.js 20 LTS
- **フレームワーク**: Hono
- **リアルタイム通信**: WebSocket (@hono/node-ws)
- **フロントエンド**: Hono JSX + htmx
- **スタイリング**: Tailwind CSS
- **テスト**: Vitest
- **言語**: TypeScript

## 開発

### テスト実行

```bash
# テスト実行
npm test

# カバレッジ付きテスト
npm test -- --coverage
```

### 型チェック

```bash
npx tsc --noEmit
```

## 環境変数

| 変数名 | 説明 | デフォルト |
|--------|------|------------|
| `PORT` | サーバーポート | 3000 |
| `NODE_ENV` | 環境識別 | development |

## デプロイ

本アプリケーションは [Render](https://render.com/) の無料枠でデプロイできます。

### Renderへのデプロイ手順

#### 方法1: Blueprintを使用（推奨）

1. GitHubリポジトリをRenderに連携
2. Render Dashboardで「New +」→「Blueprint」を選択
3. リポジトリを選択すると、`render.yaml`の設定が自動適用される

#### 方法2: 手動設定

1. [Render Dashboard](https://dashboard.render.com/) にアクセス
2. 「New +」→「Web Service」を選択
3. GitHubリポジトリを連携し、以下を設定:

| 項目 | 値 |
|------|-----|
| Name | `present-exchange`（任意） |
| Region | `Singapore` または `Oregon` |
| Branch | `main` |
| Runtime | `Node` |
| Build Command | `npm install && npm run build:css` |
| Start Command | `npm start` |
| Plan | `Free` |

4. 環境変数を設定:

| 変数名 | 値 |
|--------|-----|
| `NODE_ENV` | `production` |
| `PORT` | `10000` |

5. 「Create Web Service」をクリック

### デプロイ後のURL

デプロイ完了後、以下の形式でアクセス可能になります：

- アプリケーション: `https://{サービス名}.onrender.com`
- 参加者用WebSocket: `wss://{サービス名}.onrender.com/session/:id/ws`
- 司会者用WebSocket: `wss://{サービス名}.onrender.com/session/:id/host/ws`

### 無料枠の制限と注意事項

| 制限 | 内容 | 対策 |
|------|------|------|
| スリープ | 15分間アクセスがないとスリープ状態になる | イベント開始15分前にアクセスしてウォームアップ |
| 起動時間 | スリープからの復帰に30〜60秒かかる | 事前にセッションを作成しておく |
| 月間稼働時間 | 750時間/月まで | 単一サービスなら問題なし |
| データ永続性 | サービス再起動でセッションデータは消失 | イベント中の再デプロイは避ける |

### Node.jsバージョンについて

Renderでは2025年6月12日以降に作成されたサービスはNode.js 22.16.0がデフォルトです。本アプリケーションはNode.js 20以上で動作するため、Node.js 22でも問題なく動作します。

特定のバージョンを指定したい場合は、プロジェクトルートに`.node-version`ファイルを作成してください：

```
20.18.0
```

## 制約事項

- データはメモリ上に保持され、サーバー再起動で失われます
- セッションは作成から24時間後に自動削除されます
- 同時接続数は50名まで対応

## ライセンス

MIT
